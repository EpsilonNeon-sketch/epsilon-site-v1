<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Epsilon Valentine Quest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            margin: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Poppins', sans-serif;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        @media (max-width: 768px) {
            body {
                transform: rotate(0deg);
                transform-origin: 50% 50%;
                position: fixed;
                width: 100vh;
                height: 100vw;
                top: 0;
                left: 0;
            }

            body.landscape {
                transform: rotate(90deg);
            }

            body.portrait {
                transform: rotate(0deg);
            }
        }

        #game-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        canvas {
            display: block;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            background: linear-gradient(to bottom, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            border-radius: 16px;
            max-width: 100%;
            max-height: 80vh;
        }

        #ui-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            pointer-events: none;
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            z-index: 5;
        }

        .screen {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.95);
            z-index: 10;
            backdrop-filter: blur(5px);
            padding: 20px;
            box-sizing: border-box;
        }

        .hidden {
            display: none;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a6f);
            color: white;
            padding: 14px 28px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            border: none;
            font-size: 1.2rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(238, 90, 111, 0.4);
            touch-action: manipulation;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(238, 90, 111, 0.6);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #8b5cf6, #7c3aed);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        .btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.6);
        }

        .title {
            background: linear-gradient(45deg, #ff6b6b, #ee5a6f);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }

        .level-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            z-index: 5;
        }

        .floating-hearts {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
            pointer-events: none;
        }

        .floating-heart {
            position: absolute;
            bottom: -10%;
            color: rgba(255, 255, 255, 0.3);
            animation: float 15s infinite linear;
        }

        @keyframes float {
            0% {
                bottom: -10%;
                transform: translateX(0) rotate(0deg);
                opacity: 0;
            }

            10% {
                opacity: 0.4;
            }

            90% {
                opacity: 0.4;
            }

            100% {
                bottom: 110%;
                transform: translateX(100px) rotate(360deg);
                opacity: 0;
            }
        }

        .instructions {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* Mobile Controls */
        #mobile-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 10px;
            z-index: 15;
        }

        @media (max-width: 768px) {
            #mobile-controls {
                display: flex;
            }
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        .control-btn:active {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(0.95);
        }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #orientation-reminder {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            flex-direction: column;
            gap: 20px;
        }

        .orientation-icon {
            font-size: 80px;
            animation: rotate 2s infinite linear;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(90deg);
            }
        }

        @media (max-width: 768px) and (orientation: portrait) {
            #orientation-reminder {
                display: flex;
            }
        }

        #victory-canvas {
            border: 3px solid #ff6b6b;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin: 20px 0;
            max-width: 100%;
            height: auto;
        }

        .victory-container {
            text-align: center;
            max-width: 500px;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ff6b6b;
            animation: confetti-fall 3s linear infinite;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <div id="orientation-reminder">
        <i class="fas fa-mobile-alt orientation-icon"></i>
        <h2 class="text-2xl font-bold">Please rotate your device</h2>
        <p class="text-lg">This game is best played in landscape mode</p>
    </div>

    <div id="game-container">
        <div class="floating-hearts" id="hearts-container"></div>

        <div id="start-screen" class="screen">
            <div class="text-center">
                <h1 class="text-5xl font-bold title mb-4">Epsilon Valentine Quest</h1>
                <p class="text-2xl text-pink-600 italic mb-6">"Deliver the letter, don't fumble it."</p>
                <div class="instructions text-center text-lg text-gray-700 max-w-md">
                    <p class="mb-2"><i class="fas fa-keyboard mr-2"></i><b>Desktop:</b> Use WASD or Arrow Keys</p>
                    <p class="mb-2"><i class="fas fa-hand-pointer mr-2"></i><b>Mobile:</b> Use on-screen controls</p>
                    <p><i class="fas fa-heart mr-2"></i>Avoid obstacles and reach the heart!</p>
                </div>
                <button class="btn" onclick="startGame()">
                    <i class="fas fa-play mr-2"></i>Start Delivery
                </button>
            </div>
        </div>

        <div id="win-screen" class="screen hidden">
            <div class="victory-container">
                <h1 class="text-5xl font-bold title mb-4">ðŸŽ‰ Mission Complete! ðŸŽ‰</h1>
                <p class="text-2xl text-pink-600 mb-2">The Epsilon admins are proud of you!</p>
                <p class="text-xl text-gray-700 mb-6">Final Score: <span id="final-score">0</span></p>

                <canvas id="victory-canvas" width="400" height="300"></canvas>

                <div class="flex gap-4 justify-center mt-6">
                    <button class="btn btn-secondary" onclick="downloadVictoryImage()">
                        <i class="fas fa-download mr-2"></i>Download Victory Card
                    </button>
                    <button class="btn" onclick="resetGame()">
                        <i class="fas fa-redo mr-2"></i>Play Again
                    </button>
                </div>
            </div>
        </div>

        <div id="level-complete-screen" class="screen hidden">
            <div class="text-center">
                <h1 class="text-5xl mb-4">Level Complete!</h1>
                <p class="text-xl text-pink-600 mb-6">Score: <span id="level-score">0</span></p>
                <button class="btn" onclick="nextLevel()">
                    <i class="fas fa-arrow-right mr-2"></i>Next Level
                </button>
            </div>
        </div>

        <div id="ui-overlay">
            <i class="fas fa-star mr-2"></i>Score: <span id="score">0</span>
        </div>

        <div class="level-indicator">
            <i class="fas fa-flag mr-2"></i>Level: <span id="current-level">1</span> / <span id="total-levels">3</span>
        </div>

        <canvas id="gameCanvas"></canvas>

        <!-- Mobile Controls -->
        <div id="mobile-controls">
            <div class="control-group">
                <button class="control-btn" id="left-btn">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="control-btn" id="jump-btn">
                    <i class="fas fa-arrow-up"></i>
                </button>
                <button class="control-btn" id="right-btn">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const currentLevelEl = document.getElementById('current-level');
        const totalLevelsEl = document.getElementById('total-levels');
        const levelScoreEl = document.getElementById('level-score');
        const finalScoreEl = document.getElementById('final-score');

        // Mobile control buttons
        const leftBtn = document.getElementById('left-btn');
        const rightBtn = document.getElementById('right-btn');
        const jumpBtn = document.getElementById('jump-btn');

        // Game State
        let gameActive = false;
        let score = 0;
        let currentLevel = 1;
        let totalLevels = 3;
        let animationId;
        let particles = [];
        let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // Set total levels in UI
        totalLevelsEl.textContent = totalLevels;

        // Handle screen orientation
        function handleOrientation() {
            if (isMobile) {
                if (window.innerHeight > window.innerWidth) {
                    document.getElementById('orientation-reminder').style.display = 'flex';
                } else {
                    document.getElementById('orientation-reminder').style.display = 'none';
                }
            }
        }

        window.addEventListener('orientationchange', handleOrientation);
        window.addEventListener('resize', handleOrientation);
        handleOrientation();

        // Create floating hearts background
        function createFloatingHearts() {
            const container = document.getElementById('hearts-container');
            container.innerHTML = '';
            const heartCount = isMobile ? 5 : 10;
            for (let i = 0; i < heartCount; i++) {
                const heart = document.createElement('div');
                heart.className = 'floating-heart';
                heart.innerHTML = '<i class="fas fa-heart"></i>';
                heart.style.left = `${Math.random() * 100}%`;
                heart.style.fontSize = `${Math.random() * 20 + 10}px`;
                heart.style.animationDuration = `${Math.random() * 10 + 15}s`;
                heart.style.animationDelay = `${Math.random() * 5}s`;
                container.appendChild(heart);
            }
        }

        createFloatingHearts();

        // Game assets
        const assets = {
            player: {
                width: 40,
                height: 50,
                draw: function (x, y) {
                    // Draw player as a simple character
                    ctx.fillStyle = '#4a5568';
                    ctx.fillRect(x + 10, y, 20, 30); // Body

                    ctx.fillStyle = '#fbbf24';
                    ctx.beginPath();
                    ctx.arc(x + 20, y - 5, 12, 0, Math.PI * 2); // Head
                    ctx.fill();

                    // Eyes
                    ctx.fillStyle = '#000';
                    ctx.beginPath();
                    ctx.arc(x + 15, y - 5, 2, 0, Math.PI * 2);
                    ctx.arc(x + 25, y - 5, 2, 0, Math.PI * 2);
                    ctx.fill();

                    // Letter
                    ctx.fillStyle = '#ef4444';
                    ctx.fillRect(x + 25, y + 5, 15, 10);

                    // Arms and legs
                    ctx.strokeStyle = '#4a5568';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(x + 10, y + 10);
                    ctx.lineTo(x, y + 20);
                    ctx.moveTo(x + 30, y + 10);
                    ctx.lineTo(x + 40, y + 20);
                    ctx.moveTo(x + 15, y + 30);
                    ctx.lineTo(x + 10, y + 40);
                    ctx.moveTo(x + 25, y + 30);
                    ctx.lineTo(x + 30, y + 40);
                    ctx.stroke();
                }
            },
            target: {
                width: 50,
                height: 50,
                draw: function (x, y) {
                    // Draw heart
                    ctx.fillStyle = '#ef4444';
                    ctx.beginPath();
                    ctx.moveTo(x + 25, y + 15);
                    ctx.bezierCurveTo(x + 25, y + 10, x + 20, y + 5, x + 15, y + 5);
                    ctx.bezierCurveTo(x + 10, y + 5, x + 5, y + 10, x + 5, y + 15);
                    ctx.bezierCurveTo(x + 5, y + 20, x + 25, y + 40, x + 25, y + 40);
                    ctx.bezierCurveTo(x + 25, y + 40, x + 45, y + 20, x + 45, y + 15);
                    ctx.bezierCurveTo(x + 45, y + 10, x + 40, y + 5, x + 35, y + 5);
                    ctx.bezierCurveTo(x + 30, y + 5, x + 25, y + 10, x + 25, y + 15);
                    ctx.fill();
                }
            },
            obstacle: {
                width: 30,
                height: 40,
                draw: function (x, y) {
                    // Draw spike obstacle
                    ctx.fillStyle = '#10b981';
                    ctx.beginPath();
                    ctx.moveTo(x + 15, y);
                    ctx.lineTo(x + 30, y + 40);
                    ctx.lineTo(x, y + 40);
                    ctx.closePath();
                    ctx.fill();

                    // Add some detail
                    ctx.strokeStyle = '#059669';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(x + 15, y + 5);
                    ctx.lineTo(x + 15, y + 35);
                    ctx.stroke();
                }
            },
            platform: {
                draw: function (x, y, w, h) {
                    // Draw platform with gradient
                    const gradient = ctx.createLinearGradient(x, y, x, y + h);
                    gradient.addColorStop(0, '#f3f4f6');
                    gradient.addColorStop(1, '#d1d5db');

                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.roundRect(x, y, w, h, 10);
                    ctx.fill();

                    // Add highlight
                    ctx.strokeStyle = '#e5e7eb';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.roundRect(x, y, w, h, 10);
                    ctx.stroke();
                }
            },
            particle: {
                draw: function (x, y, color, size) {
                    ctx.fillStyle = color;
                    ctx.beginPath();
                    ctx.arc(x, y, size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        };

        const config = {
            gravity: 0.6,
            friction: 0.8,
            jumpPower: -12,
            speed: 5
        };

        let player = {
            x: 50,
            y: 0,
            width: 40,
            height: 50,
            velX: 0,
            velY: 0,
            jumping: false,
            grounded: false
        };

        let platforms = [];
        let obstacles = [];
        let target = { x: 0, y: 0, width: 50, height: 50 };

        const keys = {};

        // Level configurations
        const levels = [
            {
                // Level 1 - Easy
                platforms: [
                    { x: 0, y: 560, w: 800, h: 40 }, // Ground
                    { x: 150, y: 450, w: 150, h: 20 },
                    { x: 400, y: 380, w: 150, h: 20 },
                    { x: 150, y: 280, w: 150, h: 20 },
                    { x: 450, y: 200, w: 200, h: 20 },
                    { x: 750, y: 300, w: 150, h: 20 },
                    { x: 600, y: 150, w: 150, h: 20 }
                ],
                obstacles: [
                    { x: 450, y: 350, w: 30, h: 40 },
                    { x: 200, y: 250, w: 30, h: 40 },
                    { x: 800, y: 270, w: 30, h: 40 }
                ],
                target: { x: 650, y: 100, w: 50, h: 50 },
                playerStart: { x: 50, y: 460 }
            },
            {
                // Level 2 - Medium
                platforms: [
                    { x: 0, y: 560, w: 800, h: 40 }, // Ground
                    { x: 100, y: 480, w: 100, h: 20 },
                    { x: 250, y: 400, w: 100, h: 20 },
                    { x: 400, y: 320, w: 100, h: 20 },
                    { x: 250, y: 240, w: 100, h: 20 },
                    { x: 100, y: 160, w: 100, h: 20 },
                    { x: 550, y: 400, w: 100, h: 20 },
                    { x: 700, y: 320, w: 100, h: 20 },
                    { x: 550, y: 240, w: 100, h: 20 },
                    { x: 700, y: 160, w: 100, h: 20 }
                ],
                obstacles: [
                    { x: 270, y: 370, w: 30, h: 40 },
                    { x: 120, y: 130, w: 30, h: 40 },
                    { x: 570, y: 210, w: 30, h: 40 },
                    { x: 720, y: 130, w: 30, h: 40 },
                    { x: 420, y: 290, w: 30, h: 40 }
                ],
                target: { x: 725, y: 110, w: 50, h: 50 },
                playerStart: { x: 50, y: 460 }
            },
            {
                // Level 3 - Now Easier!
                platforms: [
                    { x: 0, y: 560, w: 800, h: 40 }, // Ground
                    { x: 100, y: 480, w: 120, h: 20 },
                    { x: 280, y: 420, w: 120, h: 20 },
                    { x: 460, y: 360, w: 120, h: 20 },
                    { x: 640, y: 300, w: 120, h: 20 },
                    { x: 200, y: 300, w: 120, h: 20 },
                    { x: 380, y: 240, w: 120, h: 20 },
                    { x: 560, y: 180, w: 120, h: 20 },
                    { x: 740, y: 120, w: 120, h: 20 }
                ],
                obstacles: [
                    { x: 300, y: 390, w: 30, h: 40 },
                    { x: 480, y: 330, w: 30, h: 40 },
                    { x: 220, y: 270, w: 30, h: 40 }
                ],
                target: { x: 775, y: 70, w: 50, h: 50 },
                playerStart: { x: 50, y: 460 }
            }
        ];

        function initLevel() {
            // Set canvas size based on device
            if (isMobile) {
                canvas.width = Math.min(window.innerWidth - 40, 800);
                canvas.height = Math.min(window.innerHeight - 150, 600);
            } else {
                canvas.width = Math.min(window.innerWidth * 0.9, 800);
                canvas.height = 600;
            }

            // Load level data
            const levelData = levels[currentLevel - 1];
            platforms = levelData.platforms;
            obstacles = levelData.obstacles;
            target = levelData.target;

            // Set player position
            player.x = levelData.playerStart.x;
            player.y = levelData.playerStart.y;
            player.velX = 0;
            player.velY = 0;

            // Update level indicator
            currentLevelEl.textContent = currentLevel;
        }

        function createParticles(x, y, color, count = 10) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x,
                    y: y,
                    velX: (Math.random() - 0.5) * 5,
                    velY: (Math.random() - 0.5) * 5,
                    color: color,
                    size: Math.random() * 5 + 2,
                    life: 30
                });
            }
        }

        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.velX;
                p.y += p.velY;
                p.velY += 0.2;
                p.life--;

                if (p.life <= 0) {
                    particles.splice(i, 1);
                }
            }
        }

        function drawParticles() {
            particles.forEach(p => {
                ctx.globalAlpha = p.life / 30;
                assets.particle.draw(p.x, p.y, p.color, p.size);
                ctx.globalAlpha = 1;
            });
        }

        function update() {
            if (!gameActive) return;

            // Movement logic
            if (keys['ArrowUp'] || keys['KeyW'] || keys['Space']) {
                if (!player.jumping && player.grounded) {
                    player.jumping = true;
                    player.grounded = false;
                    player.velY = config.jumpPower;
                    createParticles(player.x + player.width / 2, player.y + player.height, '#a78bfa', 5);
                }
            }
            if (keys['ArrowLeft'] || keys['KeyA']) {
                if (player.velX > -config.speed) player.velX--;
            }
            if (keys['ArrowRight'] || keys['KeyD']) {
                if (player.velX < config.speed) player.velX++;
            }

            player.velX *= config.friction;
            player.velY += config.gravity;

            player.grounded = false;

            // Platform Collision
            for (let i = 0; i < platforms.length; i++) {
                let plat = platforms[i];
                if (player.x < plat.x + plat.w &&
                    player.x + player.width > plat.x &&
                    player.y < plat.y + plat.h &&
                    player.y + player.height > plat.y) {

                    // Collision from top
                    if (player.velY > 0 && player.y + player.height - player.velY <= plat.y) {
                        player.grounded = true;
                        player.jumping = false;
                        player.y = plat.y - player.height;
                        player.velY = 0;
                    }
                }
            }

            player.x += player.velX;
            player.y += player.velY;

            // Screen bounds
            if (player.x <= 0) player.x = 0;
            if (player.x >= canvas.width - player.width) player.x = canvas.width - player.width;
            if (player.y > canvas.height) resetLevel(); // Fell off

            // Obstacle Collision
            obstacles.forEach(obs => {
                if (rectIntersect(player, obs)) {
                    createParticles(player.x + player.width / 2, player.y + player.height / 2, '#ef4444', 15);
                    resetLevel();
                }
            });

            // Target Collision
            if (rectIntersect(player, target)) {
                createParticles(target.x + target.width / 2, target.y + target.height / 2, '#fbbf24', 20);
                levelComplete();
            }

            // Update particles
            updateParticles();

            draw();
            animationId = requestAnimationFrame(update);
        }

        function rectIntersect(r1, r2) {
            return r1.x < r2.x + (r2.w || r2.width) &&
                r1.x + r1.width > r2.x &&
                r1.y < r2.y + (r2.h || r2.height) &&
                r1.y + r1.height > r2.y;
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw Platforms
            platforms.forEach(plat => {
                assets.platform.draw(plat.x, plat.y, plat.w, plat.h);
            });

            // Draw Player
            assets.player.draw(player.x, player.y);

            // Draw Obstacles
            obstacles.forEach(obs => {
                assets.obstacle.draw(obs.x, obs.y);
            });

            // Draw Target
            assets.target.draw(target.x, target.y);

            // Draw Particles
            drawParticles();
        }

        function resetLevel() {
            const levelData = levels[currentLevel - 1];
            player.x = levelData.playerStart.x;
            player.y = levelData.playerStart.y;
            player.velX = 0;
            player.velY = 0;
            score = Math.max(0, score - 5);
            scoreEl.innerText = score;
        }

        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('win-screen').classList.add('hidden');
            document.getElementById('level-complete-screen').classList.add('hidden');
            gameActive = true;
            score = 0;
            currentLevel = 1;
            scoreEl.innerText = score;
            initLevel();
            update();
        }

        function levelComplete() {
            gameActive = false;
            cancelAnimationFrame(animationId);
            score += 50;
            scoreEl.innerText = score;
            levelScoreEl.innerText = score;

            if (currentLevel >= totalLevels) {
                // Game complete
                finalScoreEl.innerText = score;
                createVictoryImage();
                document.getElementById('win-screen').classList.remove('hidden');
                createConfetti();
            } else {
                // Level complete, show next level screen
                document.getElementById('level-complete-screen').classList.remove('hidden');
            }
        }

        function nextLevel() {
            currentLevel++;
            document.getElementById('level-complete-screen').classList.add('hidden');
            gameActive = true;
            initLevel();
            update();
        }

        function resetGame() {
            // Clear confetti
            document.querySelectorAll('.confetti').forEach(c => c.remove());
            startGame();
        }

        // Create victory image
        function createVictoryImage() {
            const vCanvas = document.getElementById('victory-canvas');
            const vCtx = vCanvas.getContext('2d');

            // Background gradient
            const gradient = vCtx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, '#ff9a9e');
            gradient.addColorStop(1, '#fecfef');
            vCtx.fillStyle = gradient;
            vCtx.fillRect(0, 0, 400, 300);

            // Decorative hearts
            vCtx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            for (let i = 0; i < 10; i++) {
                const x = Math.random() * 400;
                const y = Math.random() * 300;
                const size = Math.random() * 20 + 10;
                drawHeart(vCtx, x, y, size);
            }

            // Main heart
            vCtx.fillStyle = '#ef4444';
            drawHeart(vCtx, 200, 120, 60);

            // Text
            vCtx.fillStyle = '#fff';
            vCtx.strokeStyle = '#ff6b6b';
            vCtx.lineWidth = 3;
            vCtx.font = 'bold 36px Poppins';
            vCtx.textAlign = 'center';
            vCtx.strokeText('VICTORY!', 200, 200);
            vCtx.fillText('VICTORY!', 200, 200);

            vCtx.font = 'bold 24px Poppins';
            vCtx.strokeText('Epsilon Valentine Quest', 200, 240);
            vCtx.fillText('Epsilon Valentine Quest', 200, 240);

            // Score
            vCtx.font = '20px Poppins';
            vCtx.fillStyle = '#4a5568';
            vCtx.fillText(`Final Score: ${score}`, 200, 270);

            // Date
            const date = new Date().toLocaleDateString();
            vCtx.font = '16px Poppins';
            vCtx.fillText(date, 200, 290);
        }

        function drawHeart(ctx, x, y, size) {
            ctx.beginPath();
            ctx.moveTo(x, y + size / 4);
            ctx.bezierCurveTo(x, y, x - size / 2, y, x - size / 2, y + size / 4);
            ctx.bezierCurveTo(x - size / 2, y + size / 2, x, y + size, x, y + size);
            ctx.bezierCurveTo(x, y + size, x + size / 2, y + size / 2, x + size / 2, y + size / 4);
            ctx.bezierCurveTo(x + size / 2, y, x, y, x, y + size / 4);
            ctx.fill();
        }

        // Download victory image
        function downloadVictoryImage() {
            const vCanvas = document.getElementById('victory-canvas');
            const link = document.createElement('a');
            link.download = 'warren jimage.png';
            link.href = vCanvas.toDataURL();
            link.click();
        }

        // Create confetti effect
        function createConfetti() {
            const colors = ['#ff6b6b', '#fbbf24', '#a78bfa', '#10b981', '#ef4444'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 3 + 's';
                    confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                    document.getElementById('win-screen').appendChild(confetti);

                    setTimeout(() => confetti.remove(), 5000);
                }, i * 50);
            }
        }

        // Keyboard controls
        window.addEventListener('keydown', e => {
            keys[e.code] = true;
            e.preventDefault();
        });
        window.addEventListener('keyup', e => {
            keys[e.code] = false;
            e.preventDefault();
        });

        // Mobile touch controls
        function addMobileControls() {
            // Left button
            leftBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                keys['ArrowLeft'] = true;
            });
            leftBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                keys['ArrowLeft'] = false;
            });
            leftBtn.addEventListener('mousedown', () => keys['ArrowLeft'] = true);
            leftBtn.addEventListener('mouseup', () => keys['ArrowLeft'] = false);

            // Right button
            rightBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                keys['ArrowRight'] = true;
            });
            rightBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                keys['ArrowRight'] = false;
            });
            rightBtn.addEventListener('mousedown', () => keys['ArrowRight'] = true);
            rightBtn.addEventListener('mouseup', () => keys['ArrowRight'] = false);

            // Jump button
            jumpBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                keys['ArrowUp'] = true;
            });
            jumpBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                keys['ArrowUp'] = false;
            });
            jumpBtn.addEventListener('mousedown', () => keys['ArrowUp'] = true);
            jumpBtn.addEventListener('mouseup', () => keys['ArrowUp'] = false);
        }

        // Initialize mobile controls if needed
        if (isMobile) {
            addMobileControls();
        }

        window.addEventListener('resize', initLevel);

        // Initial setup
        initLevel();
        draw();
    </script>
</body>

</html>
